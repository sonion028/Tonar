name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*' # 例如 v1.2.3

jobs:
  build-and-publish:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu Runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # 拉取触发工作流的 tag 对应 commit

      - name: Print GitHub context # 打印 tag 和 commit sha
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_SHA=$GITHUB_SHA"

      - name: Setup Node.js # 安装 node
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1 # 建议用 LTS 版本，稳定性更好
          registry-url: 'https://registry.npmjs.org/'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync package.json version with tag # tag 同步 package.json 版本
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "Setting package.json version to $VERSION"
          jq ".version = \"$VERSION\"" package.json > package.json.tmp
          mv package.json.tmp package.json
          cat package.json | grep version

      - name: Build with Vite
        run: npm run build

      - name: Check package contents
        run: npm pack --dry-run # 打印将要发布的文件列表，避免误发布

      - name: Publish to npm # 发布到 npm  registry
        run: |
          echo "Publishing package..."
          npm publish --access public
          echo "Publish succeeded!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
