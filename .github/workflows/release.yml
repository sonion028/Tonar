name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*' # 例如 v1.2.3

jobs:
  build-and-publish:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu Runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # 拉取触发工作流的 tag 对应 commit

      - name: Print GitHub context # 打印 tag 和 commit sha
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_SHA=$GITHUB_SHA"

      - name: Install pnpm globally # 全局安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
          # version: 10.22.0 # 不写version会读取package.json 的 packageManager

      - name: Setup Node.js # 安装 node
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1 # 建议用 LTS 版本，稳定性更好
          registry-url: 'https://registry.npmjs.org/'
          cache:
            'pnpm'

            # 调试 Node 环境（新增）
      - name: Debug Node.js
        run: |
          echo "Node.js 路径: $(which node)"
          echo "Node.js 版本: $(node -v)"
          echo "npm 路径: $(which npm)"
          echo "npm 版本: $(npm -v)"
          echo "NODE_PATH: $NODE_PATH"
          echo "PATH: $PATH"

      # 调试 pnpm 环境
      - name: Debug pnpm
        run: |
          echo "pnpm 路径: $(which pnpm)"
          echo "pnpm 版本: $(pnpm -v)"
          echo "pnpm 全局路径: $(pnpm root -g)"
          echo "PATH: $PATH"

      # 安装 jq（解决版本同步可能的依赖问题）
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install dependencies with pnpm # 使用 pnpm 安装依赖 等价于 npm ci
        run: |
          echo "开始安装依赖..."
          pnpm install --frozen-lockfile --verbose
          echo "依赖安装完成"

      - name: Sync package.json version with tag # tag 同步 package.json 版本
        run: |
          set -e
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "当前 Tag: $TAG，提取版本号: $VERSION"
          if [ -z "$VERSION" ]; then
            echo "错误：版本号为空，请检查 Tag 格式（应为 vX.Y.Z）"
            exit 1
          fi
          jq ".version = \"$VERSION\"" package.json > package.json.tmp
          mv package.json.tmp package.json
          echo "更新后 package.json 版本: $(cat package.json | grep version)"

      - name: Build with Vite
        run: |
          echo "开始构建..."
          pnpm run build --verbose
          echo "构建完成"

      # 打印将要发布的文件列表，避免误发布
      - name: Check package contents
        run: npm pack --dry-run

      # 发布到 npm  registry
      - name: Publish to npm
        run: |
          echo "开始发布到 npm..."
          npm publish --access public --verbose
          echo "发布成功"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          # 在npm生成access token，假如github具体仓库的Settings->Security->Secrets and variables->Actions
